<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KASIR APOTIK PRO</title>
    <style>
        /* === STYLE UTAMA === */
        body { font-family: 'Courier New', Courier, monospace; background: #e0e0e0; padding: 20px; }
        .box { max-width: 750px; margin: 0 auto; background: #fff; padding: 25px; border: 3px solid #000; box-shadow: 5px 5px 0px #000; }
        h2 { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-top: 0; }
        .hidden { display: none !important; }
        
        input, button, select { width: 100%; padding: 12px; margin-bottom: 12px; font-size: 16px; box-sizing: border-box; border: 2px solid #000; }
        button { background: #000; color: #fff; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { background: #444; }
        button:disabled { background: #555; cursor: wait; }
        
        table.app-table { width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 15px; }
        table.app-table th, table.app-table td { border: 1px solid #000; padding: 10px; text-align: left; vertical-align: middle; }
        table.app-table th { background: #f0f0f0; }

        .col-qty { width: 160px; text-align: center; }
        .qty-wrapper { display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-qty { width: 35px; height: 35px; background: #ddd; color: black; border: 2px solid #000; font-size: 18px; font-weight: bold; cursor: pointer; }
        .qty-display { display: inline-block; width: 50px; padding: 5px 0; text-align: center; font-size: 18px; font-weight: bold; border-bottom: 2px solid #000; background: #fff; }

        .btn-delete { background: #d32f2f; color: white; padding: 5px 10px; border: 1px solid #000; width: auto; font-size: 12px; cursor: pointer; }
        .total-box { font-size: 20px; font-weight: bold; text-align: right; padding: 10px; background: #eee; border: 2px solid #000; }
        .status-badge { display: inline-block; padding: 5px 10px; background: #000; color: #fff; font-size: 12px; margin-bottom: 15px; }

        /* === FITUR BARU: AUTOCOMPLETE SUGGESTION === */
        .autocomplete-wrapper { position: relative; display: flex; gap: 10px; }
        .suggestion-box {
            position: absolute; top: 100%; left: 0; right: 30%; /* Sesuaikan dengan tombol input */
            border: 2px solid #000; border-top: none; z-index: 99;
            background-color: #fff; max-height: 200px; overflow-y: auto;
            display: none; /* Hidden by default */
        }
        .suggestion-item {
            padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 14px;
        }
        .suggestion-item:hover { background-color: #f0f0f0; font-weight: bold; }
        .suggestion-item strong { color: blue; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 20px; border: 3px solid black; width: 350px; text-align: center; }
        .big-text { font-size: 24px; font-weight: bold; margin: 10px 0; display: block; }

        /* PRINT CSS */
        #printable-area { display: none; } 
        @media print {
            body * { visibility: hidden; }
            #screen-login, #screen-app, .box, .modal-overlay { display: none !important; }
            #printable-area, #printable-area * { visibility: visible !important; display: block !important; }
            #printable-area { position: absolute; left: 0; top: 0; width: 58mm; padding-left: 2mm; padding-right: 5mm; box-sizing: border-box; background: white; }
            @page { size: 58mm auto; margin: 0mm; }
            .struk-font { font-family: 'Courier New', Courier, monospace; font-size: 11px; line-height: 1.2; color: #000; }
            .text-center { text-align: center; }
            .dashed-line { border-bottom: 1px dashed black; margin: 5px 0; }
            .bold { font-weight: bold; }
            .no-gap { margin: 0; padding: 0; line-height: 1.2; }
            .print-table { width: 100%; border: none; border-collapse: collapse; margin-bottom: 2px; }
            .print-table td { padding: 0; border: none; vertical-align: top; }
            .align-left { text-align: left; }
            .align-right { text-align: right; }
        }
    </style>
</head>
<body>

    <div id="modal-pass" class="modal-overlay hidden">
        <div class="modal-box">
            <h3>PASSWORD ADMIN</h3>
            <input type="password" id="admin-pass-input" placeholder="***">
            <div style="display: flex; gap: 5px;">
                <button onclick="closeModal('modal-pass')" style="background: #ccc; color: black;">BATAL</button>
                <button onclick="konfirmasiHapusCepat()">OK</button>
            </div>
        </div>
    </div>

    <div id="modal-cash" class="modal-overlay hidden">
        <div class="modal-box">
            <h3>PEMBAYARAN TUNAI</h3>
            <div style="text-align: left;">Total Tagihan:</div>
            <span id="cash-total-label" class="big-text">Rp 0</span>
            <div style="text-align: left;">Uang Diterima:</div>
            <input type="number" id="cash-input" placeholder="Masukkan Nominal" onkeyup="hitungKembalian()">
            <div style="text-align: left;">Kembalian:</div>
            <span id="cash-change-label" class="big-text" style="color: blue;">Rp 0</span>
            <div style="display: flex; gap: 5px; margin-top: 15px;">
                <button onclick="closeModal('modal-cash')" style="background: #ccc; color: black;">BATAL</button>
                <button id="btn-process-cash" onclick="prosesTransaksiFinal(true)" disabled>BAYAR & CETAK</button>
            </div>
        </div>
    </div>

    <div id="screen-login" class="box">
        <h2>LOGIN SYSTEM</h2>
        <input type="text" id="login-user" placeholder="Username (admin/kasir)">
        <input type="password" id="login-pass" placeholder="Password">
        <button id="btn-login" onclick="prosesLogin()">MASUK</button>
        <p id="login-status" style="text-align: center; color: red; font-weight: bold;"></p>
        <p id="loading-text" style="text-align:center; font-size:12px; color:gray;">Memuat Database...</p>
    </div>

    <div id="screen-app" class="box hidden">
        <div style="display: flex; justify-content: space-between;">
            <span class="status-badge" id="user-badge">USER: -</span>
            <button id="btn-logout" onclick="prosesLogout()" style="width: auto; padding: 5px 15px; background: #555;">KELUAR</button>
        </div>

        <div class="autocomplete-wrapper">
            <input type="text" id="input-id" placeholder="Ketik Nama / Scan ID..." oninput="cariProduk(this.value)" onkeypress="handleEnter(event)" autocomplete="off">
            <button onclick="tambahManual()" style="width: 30%;">INPUT</button>
            
            <div id="suggestion-list" class="suggestion-box"></div>
        </div>

        <table class="app-table">
            <thead>
                <tr>
                    <th>Barang</th>
                    <th>Harga</th>
                    <th class="col-qty">Qty</th>
                    <th style="width: 40px; text-align: center;">X</th>
                </tr>
            </thead>
            <tbody id="cart-list"></tbody>
        </table>

        <div class="total-box" id="total-text">Total: Rp 0</div>
        
        <label style="font-weight: bold; margin-top: 10px; display: block;">Metode Pembayaran:</label>
        <select id="payment-method">
            <option value="CASH">Uang Tunai (CASH)</option>
            <option value="QRIS">QRIS / E-Wallet</option>
            <option value="DEBIT">Kartu Debit</option>
            <option value="CREDIT">Kartu Kredit</option>
        </select>
        <br>
        <button id="btn-bayar" onclick="cekMetodeBayar()" style="background: #000; height: 50px; font-size: 18px;">
            BAYAR & CETAK STRUK
        </button>
    </div>

    <div id="printable-area" class="struk-font">
        <br>
        <div class="text-center" style="margin-bottom: 5px;">
            <b style="font-size: 12px;">APOTIK SEHAT</b><br>
            Jl. Raya No. 123, Jakarta<br>
            --------------------------------
        </div>
        <div class="no-gap">Tgl: <span id="struk-date"></span></div>
        <div class="no-gap">No: <b id="struk-trx-id"></b></div>
        <div class="no-gap">Bayar: <b id="struk-payment"></b></div>
        <div class="dashed-line"></div>
        <div id="struk-items"></div>
        <div class="dashed-line"></div>
        <table class="print-table bold">
            <tr><td class="align-left">TOTAL:</td><td class="align-right"><span id="struk-total">0</span></td></tr>
        </table>
        <table class="print-table">
            <tr><td class="align-left" id="label-bayar">Tunai:</td><td class="align-right" id="val-bayar">0</td></tr>
            <tr><td class="align-left">Kembali:</td><td class="align-right" id="val-kembali">0</td></tr>
        </table>
        <div class="dashed-line"></div>
        <br>
        <div class="text-center" style="font-size: 10px;">
            *Terima Kasih*<br>*Barang yg dibeli tidak bisa ditukar*
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyMBtB3-CqDV3mjg5Zq5O2WYUI77-q8Pgmn4XWAC1-93iS23j4cefndPFiP2jsVWKO_/exec';
        
        let productDatabase = []; 
        let accountsDb = {}; 
        let cart = [];
        let currentUser = '';
        let grandTotal = 0; let uangTunai = 0; let uangKembali = 0;
        let adminHash = ""; 
        let itemToDeleteIndex = null;

        window.onload = function() { loadData(); };
        function loadData() { 
            fetch(SCRIPT_URL)
            .then(r => r.json())
            .then(d => { 
                productDatabase = d.products; 
                accountsDb = d.accounts;      
                document.getElementById('loading-text').innerText = "Sistem Siap!";
                document.getElementById('loading-text').style.color = "green";
            })
            .catch(e => {
                document.getElementById('loading-text').innerText = "Gagal memuat data (Offline?)";
                document.getElementById('loading-text').style.color = "red";
            }); 
        }

        // === LOGIKA AUTOCOMPLETE & PENCARIAN (BARU) ===
        function cariProduk(keyword) {
            const list = document.getElementById('suggestion-list');
            list.innerHTML = "";
            list.style.display = "none";

            if (!keyword) return;

            // Cari produk berdasarkan Nama (Case Insensitive) ATAU ID
            const matches = productDatabase.filter(p => 
                p.name.toLowerCase().includes(keyword.toLowerCase()) || 
                p.id.toString().includes(keyword)
            );

            if (matches.length > 0) {
                list.style.display = "block";
                matches.forEach(p => {
                    const div = document.createElement("div");
                    div.className = "suggestion-item";
                    div.innerHTML = `<strong>${p.name}</strong> - Stok: ${p.stock}`;
                    // Saat diklik, langsung tambah ke keranjang
                    div.onclick = function() {
                        pilihProduk(p);
                    };
                    list.appendChild(div);
                });
            }
        }

        // Fungsi saat saran diklik atau Enter ditekan
        function pilihProduk(produk) {
            document.getElementById('suggestion-list').style.display = "none"; // Tutup saran
            document.getElementById('input-id').value = ""; // Kosongkan input
            document.getElementById('input-id').focus(); // Balikin kursor
            prosesTambah(produk);
        }

        // Tombol Input Manual (Jika user mengetik ID lalu Enter/Klik Tombol)
        function tambahManual() {
            const val = document.getElementById('input-id').value;
            if(!val) return;
            
            // Cek Persis ID dulu
            let produk = productDatabase.find(p => p.id == val);
            
            // Jika ID tidak ketemu, Cek Nama Persis (atau yang paling mendekati)
            if(!produk) {
                produk = productDatabase.find(p => p.name.toLowerCase() === val.toLowerCase());
            }

            if(produk) {
                pilihProduk(produk);
            } else {
                alert("Produk tidak ditemukan!");
            }
        }

        function handleEnter(e) { 
            if(e.key === "Enter") {
                // Cek apakah ada saran yang tampil? Jika ya, ambil yang pertama
                const list = document.getElementById('suggestion-list');
                if (list.style.display === "block" && list.firstChild) {
                    list.firstChild.click(); // Klik saran paling atas
                } else {
                    tambahManual(); // Coba cari manual
                }
            }
        }

        // === LOGIKA STOK & KERANJANG (TETAP SAMA) ===
        function prosesTambah(produk) {
            const ada = cart.find(i => i.id == produk.id);
            const currentQty = ada ? ada.qty : 0;
            
            if (currentQty + 1 > produk.stock) {
                alert("STOK HABIS! Sisa Stok: " + produk.stock);
                return;
            }
            
            if(ada) ada.qty++; 
            else cart.push({...produk, qty:1}); 
            
            renderCart(); 
        }

        function updateQty(idx, num) { 
            const item = cart[idx];
            const dbProduct = productDatabase.find(p => p.id == item.id);
            if (num > 0 && item.qty + 1 > dbProduct.stock) return alert("MELEBIHI STOK! Sisa: " + dbProduct.stock);
            cart[idx].qty += num; 
            if(cart[idx].qty < 1) cart[idx].qty = 1; 
            renderCart(); 
        }

        function prosesTransaksiFinal(isCash) {
            if (isCash) closeModal('modal-cash');
            const btn = document.getElementById('btn-bayar');
            const payMethod = document.getElementById('payment-method').value;
            const now = new Date();
            const uniqueCode = Math.floor(100 + Math.random() * 900);
            const trxId = "A" + now.getDate() + (now.getMonth()+1) + uniqueCode;

            btn.innerText = "PROSES..."; btn.disabled = true; btn.style.background = "#555";

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'checkout', kasir: currentUser, items: cart, paymentMethod: payMethod, trxId: trxId })
            })
            .then(res => res.json())
            .then(response => {
                if(response.status === 'success') {
                    // UPDATE STOK LOKAL
                    cart.forEach(cartItem => {
                        const dbItem = productDatabase.find(p => p.id == cartItem.id);
                        if (dbItem) dbItem.stock -= cartItem.qty;
                    });

                    btn.innerText = "MENCETAK...";
                    siapkanStruk(payMethod, trxId);
                    setTimeout(() => {
                        window.print();
                        alert("Sukses!");
                        cart = []; renderCart();
                        btn.innerText = originalText; btn.disabled = false; btn.style.background = "#000";
                    }, 500);
                } else { throw new Error("Gagal"); }
            })
            .catch(err => {
                alert("GAGAL MENYIMPAN! Cek Koneksi.");
                btn.innerText = "BAYAR & CETAK STRUK"; btn.disabled = false; btn.style.background = "#000";
            });
        }

        // === FUNGSI LAINNYA ===
        function prosesLogin() {
            const user = document.getElementById('login-user').value.toLowerCase(); 
            const pass = document.getElementById('login-pass').value;
            if(!user || !pass) return alert("Isi lengkap!");
            if (!accountsDb[user]) return document.getElementById('login-status').innerText = "User tidak ditemukan";
            if (accountsDb[user] === btoa(pass)) { currentUser = user; adminHash = accountsDb['admin']; enterApp(); backgroundLog(user, "LOGIN"); }
            else { document.getElementById('login-status').innerText = "Password Salah!"; }
        }
        function enterApp() { document.getElementById('screen-login').classList.add('hidden'); document.getElementById('screen-app').classList.remove('hidden'); document.getElementById('user-badge').innerText = "KASIR: " + currentUser.toUpperCase(); document.getElementById('input-id').focus(); }
        function backgroundLog(user, activity) { fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'log_activity', username: user, activity: activity }) }); }
        
        function mintaHapus(index) {
            if (currentUser === 'admin') { if(confirm("Hapus item?")) { cart.splice(index, 1); renderCart(); } } 
            else { itemToDeleteIndex = index; document.getElementById('admin-pass-input').value = ""; document.getElementById('modal-pass').classList.remove('hidden'); document.getElementById('admin-pass-input').focus(); }
        }
        function konfirmasiHapusCepat() {
            if (btoa(document.getElementById('admin-pass-input').value) === adminHash) { cart.splice(itemToDeleteIndex, 1); renderCart(); closeModal('modal-pass'); } 
            else { alert("PASSWORD SALAH!"); document.getElementById('admin-pass-input').value = ""; }
        }

        function cekMetodeBayar() {
            if (cart.length === 0) return alert("Keranjang Kosong!");
            const payMethod = document.getElementById('payment-method').value;
            if (payMethod === 'CASH') {
                document.getElementById('modal-cash').classList.remove('hidden'); document.getElementById('cash-total-label').innerText = "Rp " + grandTotal.toLocaleString(); document.getElementById('cash-input').value = ""; document.getElementById('cash-change-label').innerText = "Rp 0"; document.getElementById('btn-process-cash').disabled = true; document.getElementById('cash-input').focus();
            } else { uangTunai = grandTotal; uangKembali = 0; prosesTransaksiFinal(false); }
        }
        function hitungKembalian() {
            const inputVal = document.getElementById('cash-input').value; uangTunai = Number(inputVal); uangKembali = uangTunai - grandTotal;
            document.getElementById('cash-change-label').innerText = "Rp " + uangKembali.toLocaleString();
            const btn = document.getElementById('btn-process-cash');
            if (uangTunai >= grandTotal) { document.getElementById('cash-change-label').style.color = "blue"; btn.disabled = false; btn.style.background = "#000"; } 
            else { document.getElementById('cash-change-label').style.color = "red"; btn.disabled = true; btn.style.background = "#555"; }
        }

        function siapkanStruk(metodeBayar, idTransaksi) {
            const now = new Date();
            const dateStr = now.getDate().toString().padStart(2,'0') + "/" + (now.getMonth()+1).toString().padStart(2,'0') + "/" + now.getFullYear() + " " + now.getHours() + ":" + now.getMinutes();
            document.getElementById('struk-date').innerText = dateStr; document.getElementById('struk-trx-id').innerText = idTransaksi; document.getElementById('struk-payment').innerText = metodeBayar;
            const container = document.getElementById('struk-items'); container.innerHTML = "";
            cart.forEach(item => {
                const subtotal = item.price * item.qty;
                container.innerHTML += `<div style="margin-bottom: 2px;"><div style="font-weight:bold;">${item.name.toUpperCase()}</div><table class="print-table"><tr><td class="align-left">${parseInt(item.price).toLocaleString()} x ${item.qty}</td><td class="align-right">${subtotal.toLocaleString()}</td></tr></table></div>`;
            });
            document.getElementById('struk-total').innerText = "Rp " + grandTotal.toLocaleString();
            if (metodeBayar === 'CASH') { document.getElementById('label-bayar').innerText = "Tunai:"; document.getElementById('val-bayar').innerText = uangTunai.toLocaleString(); } 
            else { document.getElementById('label-bayar').innerText = metodeBayar + ":"; document.getElementById('val-bayar').innerText = grandTotal.toLocaleString(); }
            document.getElementById('val-kembali').innerText = uangKembali.toLocaleString();
        }

        function renderCart() {
            const tbody = document.getElementById('cart-list'); tbody.innerHTML = ""; grandTotal = 0;
            cart.forEach((item, i) => {
                grandTotal += (item.price * item.qty);
                let btnDel = `<button class="btn-delete" onclick="mintaHapus(${i})">X</button>`;
                tbody.innerHTML += `<tr><td>${item.name}</td><td>${parseInt(item.price).toLocaleString()}</td><td class="col-qty"><div class="qty-wrapper"><button class="btn-qty" onclick="updateQty(${i},-1)">-</button><span class="qty-display">${item.qty}</span><button class="btn-qty" onclick="updateQty(${i},1)">+</button></div></td><td style="text-align:center;">${btnDel}</td></tr>`;
            });
            document.getElementById('total-text').innerText = "Total: Rp " + grandTotal.toLocaleString();
        }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    </script>
</body>
</html>
